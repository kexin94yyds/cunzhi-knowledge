# /ci:investigate

**模板分类**: Action
**提示级别**: 2 (Parameterized)

调查特定 PR 的 CI 失败并报告发现和修复计划。通过 `$ARGUMENTS` 提供 PR 编号。

## 调查前设置

- `git fetch --all --prune`, `git pull --rebase`
- 确保本地 `develop` 是最新的
- 从干净的工作区开始
- **不要** checkout PR 分支或在调查期间进行任何代码更改
- 此命令仅用于诊断 - 使用 `/ci-update` 实施修复

## PR 上下文收集

- 获取 PR 元数据: `gh pr view $ARGUMENTS --json number,title,headRefName,baseRefName,state`
- 从 PR 描述获取链接的问题以理解上下文
- 审查 PR diff 理解更改范围: `gh pr diff $ARGUMENTS --stat`
- 根据以下识别预期运行的工作流:
  - `.github/workflows/` 中的路径过滤器
  - 分支模式
  - 事件触发器

## CI 失败分析

- 列出 PR 的所有工作流运行: `gh run list --branch <head-ref> --limit 10`
- 对于每个失败的工作流:
  - 获取运行详情: `gh run view <run-id>`
  - 下载失败日志: `gh run view <run-id> --log-failed`
  - 识别失败的 job 和步骤
  - 提取错误消息、堆栈跟踪和退出代码
- 分类失败类型:
  - **测试失败**: 单元、集成或 e2e 测试失败
  - **Lint/typecheck 失败**: ESLint 错误、TypeScript 编译错误
  - **构建失败**: Docker 构建错误、依赖解析失败
  - **基础设施失败**: 容器启动失败、网络超时
  - **不稳定测试**: 多次运行间的间歇性失败

## 根本原因分析

- **测试失败**: 识别失败的测试文件和行号
- **Lint/typecheck 失败**: 提取精确错误位置
- **构建失败**: 识别失败的构建步骤
- **基础设施失败**: 审查 CI 工作流文件

## 修复计划

提供优先级计划：

1. **立即修复**（解除 PR 阻塞的快速胜利）
2. **验证步骤**（如何验证修复）
3. **后续行动**（长期改进）

## 报告格式

### 摘要
- PR 编号、标题、作者和分支名
- 失败工作流数量
- 失败类别
- 影响评估

### 失败工作流
- 工作流名称和运行 ID
- 失败的 job 和步骤名
- 错误消息（关键片段）
- 工作流运行链接

### 根本原因
- 失败的主要原因
- PR 中导致失败的更改文件
- 支持诊断的证据

### 修复计划
1. **立即修复**: [描述] (file:line)
2. **验证步骤**: [命令]
3. **后续行动**: [描述]

## 重要说明

- 此命令是**只读**的 - 不应进行代码编辑、提交或 GitHub 更改
- 调查期间不要运行本地测试或启动服务
- 如果根本原因不清楚，记录歧义并建议额外诊断步骤
